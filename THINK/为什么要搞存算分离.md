# 碎片化思考

1 资源隔离可以获得更好的实践
	更高的稳定性
2 技术视角和业务视角，运维视角
3 负载分流，读写分离，读读分离，写写分离，后台工作的分流
4 运维成本
5 大一统的存储为业务进行数据探索提供更多可能
6 从技术上来说，存算分离可以带来什么
7 业务场景是啥样的
8 存算分离缺点是啥？
9 参考资料，整理一些参考资料
10 实时场景如何对齐druid
11 替换flink，准确说是近实时
12 adhoc场景替换presto
13 实时场景，adhoc场景，业务调研，比如实时场景各个技术指标的分布
14 存算分离技术可以带来更好的弹性，解耦也就意味着可以弹性的可能
15 实时数仓场景，技术指标是啥，大部分需求是啥
16 对业务，更低的使用学习成本，用户期望的是傻瓜式的使用，更高的稳定性
17 引擎支持的场景更加广泛
18 思考的维度有哪些
	业务视角
	研发视角
	sre视角
	技术本身的视角,优缺点，
19 snowflake发的文章应该去哪找呢
20 最终通过存算分离改造，引擎会是个啥架构，支持啥样的场景
	也就是最终长什么样
21 是否需要现有引擎问题的梳理
22 以下列出要点，形成一个逻辑联调之后，需要进一步细化每项，如果是决策性的，最好给出理论基础，问题的核心

23 需要对存算分离的概念本身进行细化


# 梳理
1 现有问题分析
	
	业务场景分析
		具备etl的能力，包括实时场景和离线场景
		具备ap的能力，包括实时和离线场景
		具备adhoc的能力，通常分钟级

		场景细分与当前引擎
		1 实时etl，flink
		2 离线etl，spark
		3 实时ap，druid
			近实时ap，ck/doris
		4 离线ap，kylin/ck/doris

		稳定性

	用户视角
		引擎过多，学习成本过高，最好一套引擎可以搞定所有
			学习成本主要是指
				sql即是王道，以flink/mr/spark为代表的以代码编写为核心的作业提交方式无论是学习成本，开发成本，还是维护成本都是很高的
				用户需要学习的组件过多，比如flink，spark，doris，druid
		业务期望的数据产品是怎样的
			傻瓜式的使用，学习成本越低越好，夸张的说法是最好一个按钮可以搞定一切
		数据最好是统一的才可以发挥最大的价值，数据孤岛是对数据价值的削弱，使得数据失去了探索的可能
			实时数据和离线数据可以统一存储统一分析
		业务是有比较弹性的场景的，比如住宿搞的各种活动，外卖订单的特性
	
		总结来说就是，用户期望的是支持大一统混合负载同时又能够保证稳定性的系统

	平台运维视角
		sla的保证；sla保证对运营和技术双重要求
			运营的意思是要能对业务场景进行细分，包括业务的技术指标，重要程度，可参考etl生产
			有了业务场景分类之后，要做的就是做隔离；隔离的问题资源的利用率是比较低的，因此又要求有弹性
			引擎需要能够具备支持作业优先级的能力，包括查询，导入和后台线程，对sla任务可以在负载变大时增加更多资源
		引擎能力单一的话，可替代性是比较强的，团队的存在价值是比较容易受到挑战
		同用户一样，比较关注可用性与稳定性

		权衡：场景多样性先于极致性能(极致的意思是，舍弃架构舍弃场景的前提下去追求性能)
			有一款引擎可能最极致性能不如flink和ck，能处理的数据最大规模也不如spark，但是同时支持adhoc/轻量etl/ap场景并且可以提供sla级别的稳定性
			假定业务场景分布对于极致性能要求的场景是占少数的，那么这款引擎也一定会被用户作为核心引擎使用
			其他引擎的定位会成为周边工具
			从架构上来看，目前只有flink是比较难以替换的，spark并非难以替换

			我认为丰富的场景支持 + 稳定性保证，使得引擎本身具备不可替代性，团队定位不容易受到挑战
			这个结论的核心支撑点是，极端性能要求的场景比较小众化，大部分用户对极致性能的感知没那么强烈，反而会更关注学习成本以及场景多样性
			场景多样性意味着，用户大部分时间都是花在这个引擎上的，可以产生比较大的用户粘性
			谁能掌握用户的大部分数据，谁就能掌握用户
			当然对于目前各个引擎技术指标，需要更多数据支撑，以上是日常运维的个人感受

		稳定性大于一切
			不管什么架构，什么场景的引擎，稳定性都应该贯穿始终，具有最高优先级
			否则业务痛苦，运维也比较痛苦


	运维视角
		待调研

	doris现状分析
		支持的用户场景比较单一
			支持较小规模的实时数仓，大规模支持容易出现稳定性问题，目前这类任务是不做sla承诺的
			和presto比，adhoc能力比较弱，查询节点是没有弹性的
			实时ap的能力，从架构上来说和druid相差比较大

			目前doris的横向能力这几年基本就没有增长，基本就只是对已有能力的强化
			本质上还是小规模下（数据规模，负载规模）的ap引擎，不支持实时olap，无法完全替代kylin(bitmap场景)，和presto比也没啥adhoc能力，极致性能也不如ck
			未来被淘汰的风险是比较高的（目前开源里边被starrocks替代的概率比较高）

		无法支持大规模混合负载的集群，而用户又习惯在一个集群里做很多事，这会带来稳定性的风险；因此目前的主要做法是做物理隔离
			单点瓶颈比较明显 -> 
				FE可以理解为单点，数据存储不是share nothing的架构，这会明显制约集群规模
			隔离性较差 -> 集群规模(用户场景复杂度，数据规模复杂度，负载复杂度)到一定量级稳定性较差
				读读，有基于label的隔离，但是资源利用率是个问题，这势必会引起整体集群性能的下降
				读写，没有隔离
				写写，没有隔离
				后台线程 vs 读写，没有隔离
			无法满足sla运营中对于隔离性的要求

			组件未解耦
				过多模块耦合在一个进程内，从代码开发角度，一个模块出现core，整个be都是不可用的，从而影响整体稳定性

		不支持弹性，参考谷歌NAPA的设计，可以获得以下收益
			无法满足sla运营中关于任务优先级保证的需求
			除此之外有了弹性还可以支持更多业务场景

			读弹性，无
			写弹性，无
			后台线程弹性(compaction, rollup, schema change)，无
			

		物理隔离的问题；目前拆了100个集群左右，主要问题是维护成本比较高
			1 无法支撑快速迭代(BUG修复，新特性引入)，现在已经落后社区主分支两个版本了，未来升级只会更加困难
			2 多集群版本管理比较困难

			同时资源的利用率也是比较低

		核心是当前的数据规模，用户场景复杂度以及用户对于可用性的要求在当前doris的技术架构下支持起来比较吃力（纯靠堆人力）

	
	存算分离技术可以带来什么（此处需要补充现有的存算分离技术的调研，需要列一些文章调研文章出来）
		存算分离的本质是啥
			解耦
			包括计算和存储的解耦，是必须，数据和机器绑定有哪些问题

			各种计算逻辑之间的解耦，非必要，计算逻辑之间的解耦不一定需要存算分离才能实现

		
		更好的隔离
				读读分离，现有doris基于label的feature可以做读读的隔离，但问题就在于资源利用率会降低，整体性能会退化
				读写分离，不做存算分离其实也可以搞，可以加一批be的角色专门用于做导入或者后台作业，只不过对存储层调度系统的效率要求比较高
				写写分离，同上
				后台线程的解耦
		
		对弹性更好的支持
			无状态轻量级的组件比较好做弹性
		
		更高的并发支持
			当存算分离之后，集群的边界其实已经被打破
			一个集群理论上可以调起近乎无限个查询节点，这样意味着可以有很高的查询并发
			这是现有架构无论如何都无法满足的

		组件解耦
			降低单一模块故障导致的对整体集群的影响，可以参考druid，部分组件挂了依然可以提供受限的服务
			各个模块的资源分配可以更加合理

	
	基于doris的大一统引擎
			对标flink（强依赖存算分离）
				架构不兼容，对架构进行改造会违背上述【场景多样性先于极致性能】原则
				flink目前看在极致场景下是具备不可替代性的
				因此目标是，保证近实时场景下的稳定性即可

			对标druid（弱依赖存算分离）
				架构上完全兼容
				关键点应该有两处，首先是要在doris中实现真正的内存表
				其次是数据导入机制需要重新设计

			对标presto（依赖存算分离）
				架构上完全兼容
				只是需要支持隔离，弹性以及联邦查询

			对标ck
				架构上不需要做任何改造，纯代码层的优化

			对标kylin（弱依赖）
				通过支持shuffle来保证rollup是充分预聚合的，从而提升查询性能

			稳定性提升（强依赖存算分离）
				隔离
				弹性
				满足sla运营要求

			其他
				运维成本可以降低
				用户学习成本降低

	存算分离技术的缺点
		直观感受是，延迟会增加，但并非不能解决


	最终形态
		存算分离的架构
		支持弹性
		支持adhoc查询
		支持一定量级的etl操作
		在一定场景下替换掉flink（非亚秒级延迟）
		完全替换掉druid
		在支持以上所有场景的情况下，保证稳定性在三个9以上（需要论证现有架构在现有场景下是否可以满足三个9）

# 后续todo
实时etl场景技术指标分布
实时olap场景技术指标分布
presto技术指标分布
存算分离技术调研
